# Ticket: R1_EPUB3_01_IMPLEMENT_PACKAGING

> Regla: este ticket debe ser ejecutable **sin interpretación**. Si un campo no se puede responder, el ticket debe marcarse como **BLOQUEADO** y explicitar qué falta.

## Estado

- [ ] Ready
- [ ] BLOQUEADO (explicar por qué)

## Contexto

Se requiere soporte robusto para empaquetado compatible con EPUB 3.0: archivos obligatorios (`mimetype`, `META-INF/container.xml`), `OEBPS/book.opf` con `version="3.0"`, y un documento de navegación `nav.xhtml` indexado en el `manifest` con `properties="nav"`.

## Objetivo (medible)

- Generar un `.epub` que pase `epubcheck` para la especificación 3.0 (sin errores fatales).
- Incluir `nav.xhtml` y `book.opf` correctamente configurados.

## Alcance

**Incluye**:
- Generación de `mimetype` sin compresión en la primera entrada del ZIP.
- `META-INF/container.xml` apuntando a `OEBPS/book.opf`.
- `OEBPS/book.opf` con atributos y `manifest` que incluya `nav.xhtml` con `properties="nav"`.
- Tests de integración y validación con `epubcheck` en CI.

**No incluye**:
- Compatibilidad con versiones EPUB 3.x distintas a 3.0 (será R2/R3).

## Contrato funcional

### Entradas

- Metadatos básicos: `title`, `identifier`, `language`, `author`.
- Contenido XHTML (capítulos).

### Salidas

- Archivo `.epub` en `build/` válido según `epubcheck`.

### Reglas de negocio

- `mimetype` debe ser la primera entrada y almacenarse sin compresión.
- `book.opf` debe declarar `version="3.0"` y los namespaces necesarios.
- `nav.xhtml` debe estar referenciado en `manifest` con `properties="nav"`.

### Errores esperados / validaciones

- Faltan metadatos obligatorios → fallo de finalización con mensaje claro.
- `epubcheck` falla → el job CI debe marcarse como fallido.

## Datos

- Entidades: `EPub`, `Opf`, `Ncx`.
- Migraciones: No aplica.

## Permisos

- No aplica.

## UX/UI

- No aplica.

## Plan de implementación

1. Ajustar `EPub` para asegurar que `mimetype` se añade sin compresión (revisar Zip API usada).
2. Añadir creación de `META-INF/container.xml` apuntando a `OEBPS/book.opf`.
3. Implementar generación de `nav.xhtml` y añadir entrada en `manifest` con `properties="nav"`.
4. Añadir test de integración que genere un EPUB 3.0 y lo valide con `epubcheck` en CI.

## Criterios de aceptación (checklist verificable)

- [ ] `mimetype` en primer entry y sin compresión.
- [ ] `META-INF/container.xml` presente y correcto.
- [ ] `OEBPS/book.opf` versión 3.0 y `nav.xhtml` en `manifest` con `properties="nav"`.
- [ ] `epubcheck` en CI pasa para artefactos de prueba.

## Pruebas

- Happy path:
  - Generar EPUB 3.0 desde fixtures y validar con `epubcheck`.
- Edge case:
  - Generar EPUB sin `identifier` y comprobar que se genera UUID automáticamente.

## Checklist de entrega

- [ ] Docs actualizada
- [ ] Tests en verde

## Referencias

- `docs/plan/roadmap.md`
