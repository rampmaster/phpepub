# Ticket: R1_SEC_02_SANITIZE_METADATA

> Regla: este ticket debe ser ejecutable **sin interpretación**. Si un campo no se puede responder, el ticket debe marcarse como **BLOQUEADO** y explicitar qué falta.

## Estado

- [ ] Ready
- [ ] BLOQUEADO (explicar por qué)

## Contexto

Metadatos no saneados (título, autor, identificador) pueden introducir entidades no deseadas o romper la estructura XML del `book.opf` y `book.ncx`. Es necesario validar y escapar valores antes de escribirlos en los ficheros OPF/NCX.

## Objetivo (medible)

- Implementar sanitización y validación para `dc:identifier`, `title`, `author` y otros campos metadata.
- Añadir tests automatizados que prueben inyecciones y caracteres especiales.

## Alcance

**Incluye**:
- Funciones de validación y escape para metadatos.
- Tests de unidad que cubran casos especiales (ampersands, comillas, entidades, UTF-8 inválido).
- Documentación de reglas de validación.

**No incluye**:
- Cambios en la forma en que los consumidores interpretan metadatos fuera del paquete.

## Contrato funcional

### Entradas

- Strings: `title`, `author`, `identifier`, `publisher`, `description`.

### Salidas

- Strings seguras para incluir en XML (UTF-8 válido y con caracteres escapados o removidos según reglas).

### Reglas de negocio

- `dc:identifier` debe ser una URI, ISBN o UUID; si no encaja, generar UUID y marcar en logs.
- Títulos y autores deben ser codificados/escapados para XML y normalizados a NFC.

### Errores esperados / validaciones

- Entrada vacía → sustituir por valor por defecto o lanzar excepción según contexto.
- Encodings inválidos → normalizar o rechazar con mensaje claro.

## Datos

- Entidades: metadata OPF/NCX.
- Migraciones: No aplica.

## Permisos

- No aplica.

## UX/UI

- No aplica.

## Plan de implementación

1. Añadir helpers en `src/Helpers/StringHelper` o `src/Helpers/MetadataHelper` para escape/validación.
2. Reemplazar inserciones directas en `Opf::initialize` y `EPub::finalize` por llamadas al helper.
3. Añadir tests unitarios que verifiquen resultados.

## Criterios de aceptación (checklist verificable)

- [ ] `dc:identifier` validado y fallback a UUID si inválido.
- [ ] Títulos/autores escapados correctamente en `book.opf`.
- [ ] Tests con caracteres especiales pasan.

## Pruebas

- Happy path:
  - Título normal se incluye sin cambios.
- Edge case:
  - Título con `&` se incluye escapado (`&amp;`) y `book.opf` sigue siendo XML válido.

## Checklist de entrega

- [ ] Docs actualizada
- [ ] Tests en verde

## Referencias

- `docs/plan/roadmap.md`
